_provides_pkgname=mesa
pkgname=mesa-grate
pkgver=18.1.0
pkgrel=1
pkgdesc="Mesa DRI OpenGL library"
url="http://www.mesa3d.org"
arch="all"
license="MIT SGI-B-2.0 BSL-1.0"
subpackages="$pkgname-dev
	$pkgname-dri-ati:_dri
	$pkgname-dri-nouveau:_dri
	$pkgname-dri-freedreno:_dri
	$pkgname-dri-swrast:_dri
	$pkgname-dri-virtio:_dri
	$pkgname-glapi $pkgname-egl $pkgname-gl $pkgname-gles
	$pkgname-xatracker $pkgname-osmesa $pkgname-gbm
	"
_llvmver=5
depends_dev="libdrm-dev dri2proto libxext-dev libxdamage-dev libxcb-dev glproto
	dri3proto presentproto libxshmfence-dev"
makedepends="$depends_dev expat-dev xextproto python3 libxt-dev makedepend
	talloc-dev py3-libxml2 flex bison llvm$_llvmver-dev eudev-dev libvdpau-dev
	libxvmc-dev gettext zlib-dev libelf-dev py-mako libva-dev
	autoconf automake libtool libxxf86vm-dev libx11-dev libxfixes-dev
	libdrm-grate-dev"
branch=e84d295e03b38c616b7847003676c137912d19a8
source="https://github.com/grate-driver/mesa/archive/$branch.tar.gz
	0001-drmdeps.patch
	0002-glx-ro-text-segm.patch
	0003-musl-fix-includes.patch
	0004-musl-fixes.patch"
replaces="mesa-dricore mesa"

_dri_driverdir=/usr/lib/xorg/modules/dri
_dri_drivers="r200,radeon,nouveau,swrast"
_gallium_drivers="r300,r600,nouveau,freedreno,swrast,virgl"
_vulkan_drivers=""

builddir="$srcdir/mesa-$branch"

_arch_opts=

case "$CARCH" in
x86*)
	_dri_drivers="${_dri_drivers},i915,i965"
	_gallium_drivers="${_gallium_drivers},svga"
	_vulkan_drivers="$_vulkan_drivers,intel"
	subpackages="$subpackages $pkgname-dri-intel:_dri $pkgname-dri-vmwgfx:_dri $pkgname-vulkan-intel:_vulkan"
	_arch_opts="--enable-dri3"
	case "$CARCH" in
	x86) _arch_opts="$_arch_opts --enable-glx-rts --disable-asm";;
	esac
	;;
armhf|aarch64)
	_gallium_drivers="${_gallium_drivers},grate,vc4"
	subpackages="$subpackages $pkgname-dri-grate:_dri $pkgname-dri-vc4:_dri"
	case "$CARCH" in
	armhf) CFLAGS="$CFLAGS -mfpu=vfpv3-d16";;
	esac
	;;
esac

prepare() {
	cd "$builddir"
	default_prepare
	libtoolize --force \
		&& aclocal \
		&& automake --add-missing \
		&& autoreconf
}

build() {
	cd "$builddir"

	export CFLAGS="$CFLAGS -D_XOPEN_SOURCE=700"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--with-dri-driverdir=$_dri_driverdir \
		--with-gallium-drivers=${_gallium_drivers} \
		--with-dri-drivers=${_dri_drivers} \
		--with-vulkan-drivers=${_vulkan_drivers} \
		--with-llvm-prefix=/usr/lib/llvm$_llvmver \
		--with-platforms=x11,drm \
		--disable-llvm \
		--enable-shared-glapi \
		--enable-gbm \
		--enable-dri \
		--enable-glx \
		--enable-gallium-osmesa \
		--enable-gles1 \
		--enable-gles2 \
		--enable-egl \
		--enable-texture-float \
		--enable-xa \
		--enable-vdpau \
		--enable-va \
		--disable-xvmc \
		--disable-glx-tls \
		--disable-nine \
		$_arch_opts
	make
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install
}

override_package() {
	replaces="$replaces ${subpkgname/${pkgname}/${_provides_pkgname}}"
	provides="${subpkgname/${pkgname}/${_provides_pkgname}}"
}

dev() {
	default_dev
	provides="mesa-dev"
}

doc() {
	default_doc
	provides="mesa-doc"
}

egl() {
	pkgdesc="Mesa libEGL runtime libraries"
	replaces="mesa"
	override_package

	install -d "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libEGL.so* "$subpkgdir"/usr/lib/
}

gl() {
	pkgdesc="Mesa libGL runtime libraries"
	replaces="mesa"
	override_package

	install -d "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libGL.so* "$subpkgdir"/usr/lib/
}

glapi() {
	pkgdesc="Mesa shared glapi"
	replaces="$pkgname-gles"
	override_package

	install -d "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libglapi.so.* "$subpkgdir"/usr/lib/
}

gles() {
	pkgdesc="Mesa libGLESv2 runtime libraries"
	replaces="mesa"
	override_package

	install -d "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libGLES*.so* "$subpkgdir"/usr/lib/
}

xatracker() {
	pkgdesc="Mesa XA state tracker for vmware"
	replaces="mesa"
	override_package

	install -d "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libxatracker*.so.* "$subpkgdir"/usr/lib/
}

osmesa() {
	pkgdesc="Mesa offscreen rendering libraries"
	replaces="mesa"
	override_package

	install -d "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libOSMesa.so.* "$subpkgdir"/usr/lib/
}

gbm() {
	pkgdesc="Mesa gbm library"
	replaces="mesa"
	override_package

	install -d "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libgbm.so.* "$subpkgdir"/usr/lib/
}

_mv_dri() {
	install -d "$subpkgdir"/$_dri_driverdir

	while [ $# -gt 0 ]; do
		mv "$pkgdir"/$_dri_driverdir/${1}.so \
			"$subpkgdir"/$_dri_driverdir/
		shift
	done
}

_mv_vdpau() {
	local i
	install -d "$subpkgdir"/usr/lib/vdpau
	for i in "$@"; do
		mv "$pkgdir"/usr/lib/vdpau/libvdpau_$i.* \
			"$subpkgdir"/usr/lib/vdpau/
	done
}

_mv_gpipe() {
	return 0
	# http://cgit.freedesktop.org/mesa/mesa/commit/?id=44ec468e8033553c26a112cebba41c343db00eb1
	# https://code.google.com/p/chromium/issues/detail?id=412089
#	local i
#	install -d "$subpkgdir"/usr/lib/gallium-pipe
#	for i in "$@"; do
#		mv "$pkgdir"/usr/lib/gallium-pipe/pipe_$i.* \
#			"$subpkgdir"/usr/lib/gallium-pipe/
#	done
}

_mv_vulkan() {
	local i
	install -d "$subpkgdir"/usr/lib
	install -d "$subpkgdir"/usr/share/vulkan/icd.d
	for i in "$@"; do
		mv "$pkgdir"/usr/lib/libvulkan_${i}.so "$subpkgdir"/usr/lib/
		mv "$pkgdir"/usr/share/vulkan/icd.d/${i}* "$subpkgdir"/usr/share/vulkan/icd.d/
	done
}

_mv_va() {
	local i
	install -d "$subpkgdir"/usr/lib/dri
	for i in "$@"; do
		mv "$pkgdir"/usr/lib/dri/${i}_drv_video.so \
			"$subpkgdir"/usr/lib/dri/
	done
}

_dri() {
	local n=${subpkgname##*-dri-}
	pkgdesc="Mesa DRI driver for $n"
	override_package

	case $n in
	ati)
		_mv_dri radeon_dri r200_dri r300_dri r600_dri \
			&& _mv_vdpau r300 r600 \
			&& _mv_gpipe r300 r600 \
			&& _mv_va r600
		;;
	intel)
		_mv_dri i915_dri i965_dri
		;;
	nouveau)
		_mv_dri nouveau_dri nouveau_vieux_dri \
			&& _mv_vdpau nouveau \
			&& _mv_gpipe nouveau \
			&& _mv_va nouveau
		;;
	freedreno)
		_mv_dri msm_dri kgsl_dri
		;;
	swrast)
		_mv_dri swrast_dri kms_swrast_dri && _mv_gpipe swrast
		;;
	grate)
		_mv_dri tegra_dri
		;;
	vc4)
		_mv_dri vc4_dri
		;;
	vmwgfx)
		_mv_dri vmwgfx_dri && _mv_gpipe vmwgfx
		;;
	virtio)
		_mv_dri virtio_gpu_dri
		;;
	esac
}

_vulkan() {
	local n=${subpkgname##*-vulkan-}
	pkgdesc="Mesa Vulkan API driver for $n"
	override_package

	case $n in
	ati)
		_mv_vulkan radeon ;;
	intel)
		_mv_vulkan intel ;;
	esac
}
sha512sums="6b613f3e2ab1d2a1aa6241a55dc3196c988f6f2dfa95e43014a2db5062c412101733c9005809920b59646f5232745092b01a7ea0b9c6268202ba892a2671ca8d  e84d295e03b38c616b7847003676c137912d19a8.tar.gz
8f6bb8610b754ed233bfd5443541c31562d4b5460d77b6a2c017f6139b1723d44ffca80df1be559e1de7b326591d231be9ef7a66436a9885cc966be49ff90a49  0001-drmdeps.patch
bd8eb6868dd3d74bb6f0caa9cff938749e008950717f7f011fc1e4cf7e15b020d9bc79e0f5dea17c2d6631f5ec1aa00260a016a32a56697cc816952f9e622d19  0002-glx-ro-text-segm.patch
4b0ef61994cba254a4d6d02b486f744b4555043ddf453e387d256c6a6201a236029e9790096bc02cc11924fa76cfe5c82663ad96ef7992d9aeeb427af541348e  0003-musl-fix-includes.patch
ebf94b59ed2909a23c87bb7b7ff4d3e0d921420f3cf64c39f7b8e180ebf878f7a74bf5d1281de5bfe94773bf3b47f99ab72edf74802a7e82d6b3346bb40f699b  0004-musl-fixes.patch"
