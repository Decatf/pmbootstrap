_provides_pkgname=libdrm
pkgname=libdrm-grate
pkgver=2.4.91
pkgrel=0
pkgdesc="Userspace interface to kernel DRM services"
url="https://www.github.com/grate-driver/"
arch="all"
# Requires a computer with gfx, no X running, build user in 'video' group..
options="!check"
license="MIT"
depends=""
depends_dev="linux-headers"
makedepends="$depends_dev musl-dev build-base libpthread-stubs eudev-dev libpciaccess-dev xmlto
	libtool m4 automake autoconf
	util-macros
	valgrind-dev
	"
checkdepends="cunit-dev bash"
subpackages="$pkgname-dev $pkgname-doc"
source="https://dri.freedesktop.org/$_provides_pkgname/$_provides_pkgname-$pkgver.tar.bz2
	ioctl.patch
	0001-grate-driver.patch
	"
replaces="$_provides_pkgname $_provides_pkgname-dev $_provides_pkgname-doc"
provides="$_provides_pkgname"
builddir="$srcdir/$_provides_pkgname-$pkgver"

prepare() {
	cd "$builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i;;
		esac
	done
	libtoolize --force \
		&& aclocal \
		&& automake --add-missing \
		&& autoreconf
}

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--enable-tegra-experimental-api \
		--enable-freedreno \
		--enable-vmwgfx \
		--enable-nouveau \
		--enable-amdgpu \
		--enable-radeon \
		--enable-intel \
		--disable-vc4 \
		--enable-udev \
		--disable-valgrind
	make
}

check() {
	cd "$builddir"
	make check
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install
}

override_package() {
	provides="${subpkgname/${pkgname}/${_provides_pkgname}}"
	replaces="${subpkgname/${pkgname}/${_provides_pkgname}}"
}

dev() {
	default_dev
	override_package
}

doc() {
	default_doc
	override_package
}

sha512sums="07578c00c121ba37033db7172590e26d1545f81c242bbce2cfb7fb904bde504822c275d6468e5c5d20360d0046ae73d9b058aa0459ba35eb11927141cc998772  libdrm-2.4.91.tar.bz2
af52fef51aaa05a4dd17919371cb9d92a77480402730bf53ba223e54df52f3825be05a7f28e6aef8c904db5ee59fe38a6c15bc6aafa7f8d31a719e80399dd51f  ioctl.patch
cfebf230443435c04240a818f95bd39d502f6f8d098eda1b27c5289d54cf75b90ab44d60046d84f2631a44d80c45cca4a9798669ab47829aa1ae78466315afc0  0001-grate-driver.patch"
